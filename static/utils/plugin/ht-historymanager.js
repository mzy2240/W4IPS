!function(n,Y,g){"use strict";var b="ht",F=n[b],u=F.Default,f=u.def,c=u.getInternal();F.HistoryManager=function(m){this._histories=[],this.setDataModel(m)},f(F.HistoryManager,Y,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var $=this;$._betweenTransaction++,1===$._betweenTransaction&&($._transactionHistories=[])}},endTransaction:function(){if(!this._disabled){var Y=this,O=Y._histories;Y._betweenTransaction>0&&Y._betweenTransaction--,0===Y._betweenTransaction&&(Y._transactionHistories&&Y._transactionHistories.length&&(O=O.slice(0,Y._historyIndex+1),O.push(Y._transactionHistories),O.length>Y._maxHistoryCount&&(O=O.slice(O.length-Y._maxHistoryCount)),Y.setHistories(O),Y.setHistoryIndex(O.length-1,!0)),delete Y._transactionHistories)}},setDataModel:function(o){var T=this,k=T._dataModel;k!==o&&(k&&(delete k._historyManager,k.ump(T.handleDataModelPropertyChange,T),k.umm(T.$5p,T),k.umd(T.$6p,T),k.removeHierarchyChangeListener(T.handleHierarchyChange,T),k.removeIndexChangeListener(T.handleIndexChange,T)),T._dataModel=o,o&&(o._historyManager=T,o.mp(T.handleDataModelPropertyChange,T),o.mm(T.$5p,T),o.md(T.$6p,T),o.addHierarchyChangeListener(T.handleHierarchyChange,T),o.addIndexChangeListener(T.handleIndexChange,T)),T.fp("dataModel",k,o),T.clear())},setHistoryIndex:function(B,V){var $=this,r=$._historyIndex,w=$._histories.length;if(-1>B?B=-1:B>=w&&(B=w-1),r!==B){if(!V){var x=B-r;x>0?$.$2p(x):0>x&&$.$1p(-x)}$._historyIndex=B,$.fp("historyIndex",r,B),$.dataModel&&$.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(W){var T=this,e=T._histories,l=T._maxHistoryCount;(!W||0>=W)&&(W=10),l!==W&&(T._maxHistoryCount=W,T.fp("maxHistoryCount",l,W),e.length>W&&T.clear())},cloneValue:function(K){return F.Default.clone(K)},isPropertyUndoable:function(L){return L&&!this.ignoredPropertyMap[L]},isDataModelPropertyUndoable:function(D){return D&&!this.ignoreDataModelPropertyMap[D]},$5p:function(V){this.handleChange(V,V.kind)},$6p:function(K){this.handleChange(K,"property")},handleHierarchyChange:function(j){this.handleChange(j,"hierarchy")},handleIndexChange:function(a){this.handleChange(a,"index")},handleDataModelPropertyChange:function(Z){this.handleChange(Z,"dataModelProperty")},toChildrenInfo:function(v){var f={};return f.data=v,f.children=[],v.eachChild(function(N){f.children.push(this.toChildrenInfo(N))},this),f},restoreChildren:function(b){var s=b.data;b.children.forEach(function(N){var d=N.data;d.getParent()!==s&&s.addChild(d),this._dataModel.contains(d)||this._dataModel.add(d),this.restoreChildren(N)},this)},handleChange:function(C,h){var Q=this;if(!(Q._disabled||Q._isUndoRedoing||u.loadingRefGraph)){var v,K=(Q._histories,C.data),H=C.property;if(!K||!(K._refGraph||K instanceof F.RefGraph)){if("property"===h)Q.isPropertyUndoable(H,K)&&(v={kind:h,data:K,property:H,oldValue:Q.cloneValue(C.oldValue,K,H),newValue:Q.cloneValue(C.newValue,K,H),event:C});else if("hierarchy"===h||"index"===h)v={kind:h,data:K,oldIndex:C.oldIndex,newIndex:C.newIndex,event:C};else if("clear"===h)v={kind:h,json:C.json,event:C};else if("add"===h){if(v={kind:h,data:K,event:C,childrenInfo:this.toChildrenInfo(K),parent:K.getParent()},v.parent){var k=Q._dataModel.getSiblings(K);v.siblingsIndex=k.indexOf(K)}K instanceof F.Node&&(v.host=K.getHost(),v.attaches=K.getAttaches()?K.getAttaches().toArray():g),K instanceof F.Edge&&(v.source=K.getSource(),v.target=K.getTarget())}else"remove"===h?v={kind:h,data:K,event:C}:"dataModelProperty"===h&&Q.isDataModelPropertyUndoable(H,K)&&(v={kind:h,property:H,oldValue:Q.cloneValue(C.oldValue,K,H),newValue:Q.cloneValue(C.newValue,K,H),event:C});Q.addHistory(v)}}},addHistory:function(H){var O=this;if(H)if(O._betweenTransaction){var T=!1;if("property"===H.kind||"dataModelProperty"===H.kind)for(var p=O._transactionHistories.length-1;p>=0;p--){var w=O._transactionHistories[p];if(H.kind===w.kind&&H.property===w.property&&H.data===w.data){H.oldValue=w.oldValue,O._transactionHistories[p]=H,T=!0;break}}T||O._transactionHistories.push(H)}else{var q=O._histories;q=q.slice(0,O._historyIndex+1),q.push([H]),q.length>O._maxHistoryCount&&(q=q.slice(q.length-O._maxHistoryCount)),O.setHistories(q),O.setHistoryIndex(q.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(V){(!V||0>=V)&&(V=1),this.setHistoryIndex(this._historyIndex-V)},$1p:function(O){if(this.canUndo()){var A,H=this,C=H._dataModel,g=H._histories,Y=H._historyIndex,R=0;for(H._isUndoRedoing=!0,u.setIsolating(!0);O>0;){if(Y>=0&&Y<g.length){R++,A=g[Y],Y--;for(var d=A.length-1;d>=0;d--){var X=A[d],D=X.kind,i=X.data,p=X.property,m=X.event,B=this.cloneValue(X.oldValue,i,p);if(X.undo)X.undo();else if("add"===D)C.remove(i,{keepChildren:!0});else if("remove"===D)C.contains(i)||C.add(i,m.rootsIndex,m.datasIndex);else if("clear"===D)C.deserialize(u.clone(X.json));else if("property"===D)if("parent"===p)B?B.addChild(i,m.oldIndex):(i.setParent(B),m.oldIndex>=0&&C.moveTo(i,m.oldIndex));else{var W=null;0===p.indexOf("a:")?(W="attr",p=p.replace("a:","")):0===p.indexOf("s:")?(W="style",p=p.replace("s:","")):0===p.indexOf("f:")&&(W="field",p=p.replace("f:","")),c.setPropertyValue(i,W,p,B)}else if("dataModelProperty"===D){var W=null;0===p.indexOf("a:")?(W="attr",p=p.replace("a:","")):0===p.indexOf("s:")?(W="style",p=p.replace("s:","")):0===p.indexOf("f:")&&(W="field",p=p.replace("f:","")),c.setPropertyValue(C,W,p,B)}else"hierarchy"===D?C.moveTo(i,X.oldIndex):"index"===D&&C.moveToIndex(i,X.oldIndex)}}O--}u.setIsolating(!1),delete H._isUndoRedoing,H.afterUndo(R)}},afterUndo:function(){},redo:function(q){(!q||0>=q)&&(q=1),this.setHistoryIndex(this._historyIndex+q)},$2p:function(L){if(this.canRedo()){var $,Z=this,y=Z._dataModel,K=Z._histories,V=Z._historyIndex,w=0;for(Z._isUndoRedoing=!0,u.setIsolating(!0);L>0;){if(V>=-1&&V<K.length-1){w++,V++,$=K[V];for(var b=0;b<$.length;b++){var X=$[b],j=X.kind,s=X.data,q=X.property,p=X.event,x=this.cloneValue(X.newValue,s,q);if(X.redo)X.redo();else if("add"===j)X.parent&&!s.getParent()&&X.parent.addChild(s,X.siblingsIndex),y.contains(s)||y.add(s,p.rootsIndex,p.datasIndex),this.restoreChildren(X.childrenInfo),s instanceof F.Node&&(s.setHost(X.host),X.attaches&&X.attaches.forEach(function(d){d.setHost(s)})),s instanceof F.Edge&&(s.setSource(X.source),s.setTarget(X.target));else if("remove"===j)y.remove(s);else if("clear"===j)y.clear();else if("property"===j)if("parent"===q)x?x.addChild(s,p.newIndex):(s.setParent(x),p.newIndex>=0&&y.moveTo(s,p.newIndex));else{var D=null;0===q.indexOf("a:")?(D="attr",q=q.replace("a:","")):0===q.indexOf("s:")?(D="style",q=q.replace("s:","")):0===q.indexOf("f:")&&(D="field",q=q.replace("f:","")),c.setPropertyValue(s,D,q,x)}else if("dataModelProperty"===j){var D=null;0===q.indexOf("a:")?(D="attr",q=q.replace("a:","")):0===q.indexOf("s:")?(D="style",q=q.replace("s:","")):0===q.indexOf("f:")&&(D="field",q=q.replace("f:","")),c.setPropertyValue(y,D,q,x)}else"hierarchy"===j?y.moveTo(s,X.newIndex):"index"===j&&y.moveToIndex(s,X.newIndex)}}L--}u.setIsolating(!1),delete Z._isUndoRedoing,this.afterRedo(w)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);